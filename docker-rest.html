<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Dockering DCTM REST</title>
    <meta name="description" content="A framework for easily creating beautiful presentations using HTML">
    <meta name="author" content="Hakim El Hattab">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/league.css" id="theme">
    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">
    <!-- Printing and PDF exports -->
    <script>
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
    document.getElementsByTagName('head')[0].appendChild(link);
    </script>
    <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
</head>

<body>
    <div class="reveal">
        <!-- Any section element inside of this container is displayed as a slide -->
        <div class="slides">
            <section>
                <h1>Dockerizing DCTM REST</h1>
                <h3>Container Tech and REST Services</h3>
                <p>
                    <small>Represented by <a href="mailto:Chen.Wang@emc.com">Chen Wang</a></small>
                </p>
            </section>
            <section>
                <h2>Traditional way to deliver REST</h2>
                <p class="fragment">WEB ARchive (WAR)</p>
                <img width="50%" height="50%" class="fragment" data-src="docker-rest/rest-deliver.png">
                <p class="fragment">it's just the begining of the story</p>
                <p class="fragment">...</p>
            </section>
            <section>
                <section>
                    <h3>Release Notes tell us</h3>
                    <p>many constraints about deploying REST</p>
                </section>
                <section>
                    <h4>OS requirements</h4>
                    <img class="fragment" src="docker-rest/os-req.png">
                </section>
                <section>
                    <h4>Web application server requirements</h4>
                    <img width="80%" height="80%" class="fragment" src="docker-rest/web-server-req.png">
                    <p class="fragment">...</p>
                </section>
                <section>
                    <h4>Web app server configuration</h4>
                    <img src="docker-rest/tomcat-config.png">
                </section>
                <section>
                    <h4>JAVA</h4>
                    <p class="fragment">version and vendor</p>
                </section>
            </section>
            <section>
                <h3>Before REST running</h3>
                <ol>
                    <li class="fragment">prepare OS</li>
                    <li class="fragment">download and install Java</li>
                    <li class="fragment">download and configure web app server</li>
                    <li class="fragment">deploy WAR</li>
                </ol>
            </section>
            <section>
                <h2>About Docker</h2>
                <p class="fragment">lightweight</p>
                <p class="fragment">flexible</p>
                <p class="fragment">easy use... Dockerfile</p>
                <p class="fragment">build once... run everywhere</p>
                <p class="fragment">cheap</p>
            </section>
            <section>
                <h3>Dockerizing REST - Why</h3>
                <p class="fragment">REST is stateless</p>
                <p class="fragment">local development and test</p>
                <p class="fragment">CI</p>
                <p class="fragment">production application deployment</p>
                <p class="fragment">new approach to deliver application</p>
            </section>
            <section>
                <section>
                    <h3>Dockerizing REST - What</h3>
                    <p class="fragment grow highlight-blue">complex configuration</p>
                    <p>logging</p>
                    <p>Operating System/Java Verson and Vendor/Web App Server</p>
                    <p>SSL support</p>
                </section>
                <section>
                    <h4>complex configuration</h4>
                    <p class="fragment"><a href="docker-rest/rest-api-runtime.properties.template">rest-api-runtime.properties</a><span class="fragment"> - 100+ options</span></p>
                    <p class="fragment"><a href="docker-rest/dfcfull.properties">rest-api-runtime.properties</a><span class="fragment fade-up"> - about 170 options</span></p>
                    <i class="fragment">docker environment variables are not sufficient</i>
                </section>
                <section>
                    <h3>Dockerizing REST - What</h3>
                    <p>complex configuration</p>
                    <p class="fragment grow highlight-blue">logging</p>
                    <p>Operating System/Java Verson and Vendor/Web App Server</p>
                    <p>SSL support</p>
                </section>
                <section>
                    <h4>logging</h4>
                    <p class="fragment fade-right">logging is important for troubleshooting</p>
                    <p class="fragment fade-left">logs should be persisted</p>
                </section>
                <section>
                    <h3>Dockerizing REST - What</h3>
                    <p>complex configuration</p>
                    <p>logging</p>
                    <p class="fragment grow highlight-blue">Operating System/Java Verson and Vendor/Web App Server</p>
                    <p>SSL support</p>
                </section>
                <section>
                    <h4>environment</h4>
                    <p class="fragment fade-right">OpenJDK 1.8</p>
                    <p class="fragment fade-left">Tomcat 8.0</p>
                    <p class="fragment fade-left">Ubuntu 16.04 and CentOS 7</p>
                </section>
                <section>
                    <h3>Dockerizing REST - What</h3>
                    <p>complex configuration</p>
                    <p>logging</p>
                    <p>Operating System/Java Verson and Vendor/Web App Server</p>
                    <p class="fragment grow highlight-blue">SSL support</p>
                </section>
                <section>
                    <h4>SSL support</h4>
                    <p class="fragment">keystore location</p>
                    <p class="fragment">keystore password</p>
                    <p class="fragment">key entry</p>
                    <p class="fragment">key entry password</p>
                    <p class="fragment">encryption algorithm</p>
                </section>
            </section>
            <section data-background="#4d7e65">
                <p>start REST container first</p>
                <p>and come back to answer these questions</p>
            </section>
            <section>
                <h2>Run REST container</h2>
                <ol>
                    <li class="fragment">load REST image</li>
                    <pre class="fragment"><code class="hljs" data-trim contenteditable>
tar -xvf RESTAPI_Docker_Ubuntu.tar
docker load -i RESTAPI_Ubuntu.tar
                    </code></pre>
                    <li class="fragment">make work directory</li>
                    <pre class="fragment"><code class="hljs" data-trim contenteditable>
mkdir -p ~/rest/config
cd ~/rest
                    </code></pre>
                    <li class="fragment">prepare configuration files</li>
                    <li class="fragment">start container</li>
                    <pre class="fragment"><code class="hljs" data-trim contenteditable>
docker run --name rest -p 8080:8080 -d \
    -v `pwd`/config:/root/rest/config \
    -v `pwd`/logs:/root/rest/logs restapi_ubuntu:7.3.0000.0590
                    </code></pre>
                    <li class="fragment">verify REST service</li>
                    <pre class="fragment"><code class="hljs" data-trim contenteditable>
curl http://dmadmin:password@localhost:8080/dctm-rest/repositories/REPO
                    </code></pre>
                </ol>
            </section>
            <section>
                <h3>Check logs</h3>
                <p class="fragment fade-left">in `pwd`/logs</p>
            </section>
            <section>
                <h3>what if re-configure?</h3>
                <p class="fragment">modify configuration and restart the container</p>
                <pre class="fragment"><code class="hljs" data-trim contenteditable>
vi config/log4j.properties
vi config/dfc.properties
docker restart rest
                    </code></pre>
            </section>
            <section data-background="#000000" data-background-transition="zoom">
                <h3>Dockerizing REST - How</h3>
                <a href="docker-rest/design.png"><img width="70%" class="fragment" src="docker-rest/design.png" alt=""></a>
            </section>
            <section>
                <h4>Dockerfile</h4>
                <i><a href="docker-rest/Dockerfile-ubuntu1604">Dockerfile for ubuntu 16.04</a></i>
                <pre><code class="hljs" data-trim contenteditable>
FROM ubuntu:16.04

MAINTAINER Chen Wang

# Tomcat env vars
ENV TOMCAT_MAJOR 8
ENV TOMCAT_VERSION 8.0.36
ENV TOMCAT_TGZ_URL https://www.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz
ENV CATALINA_HOME /opt/tomcat
ENV PATH $PATH:$CATALINA_HOME/bin

# Install JRE 8 and tomcat
RUN \
apt-get update && \
apt-get install -y openjdk-8-jre && \
apt-get install -y wget && \
apt-get install -y unzip && \
rm -rf /var/lib/apt/lists/* && \
wget --quiet --no-cookies ${TOMCAT_TGZ_URL} -O /tmp/tomcat.tgz && \
tar xzvf /tmp/tomcat.tgz -C /opt && \
mv /opt/apache-tomcat-${TOMCAT_VERSION} ${CATALINA_HOME} && \
rm /tmp/tomcat.tgz && \
rm -rf ${CATALINA_HOME}/webapps/examples && \
rm -rf ${CATALINA_HOME}/webapps/docs && \
rm -rf ${CATALINA_HOME}/webapps/ROOT
                    </code></pre>
            </section>
            <section>
                <h2>REST with HTTPS</h2>
                <p class="fragment">5 more environment variables</p>
                <pre class="fragment"><code class="hljs" data-trim contenteditable>
-e COMM_KEYSTORE_FILE=...
-e COMM_KEYSTORE_PWD=... 
-e COMM_KEY_ALIAS=... 
-e COMM_KEY_PWD=... 
-e COMM_KEY_STORE_TYPE=... 
                </code></pre>
            </section>
            <section>
                <h2>REST with HTTPS (cont.)</h2>
                <pre class="fragment"><code class="hljs" data-trim contenteditable>
keytool -genkey -alias tomcat -keyalg RSA -keystore ./myks
                </code></pre>
                <pre class="fragment"><code class="hljs" data-trim contenteditable>
docker run --name rest -p 8080:8080 -d \
    -v `pwd`/config:/root/rest/config \
    -v `pwd`/logs:/root/rest/logs 
    -e COMM_KEYSTORE_FILE=/root/rest/config/security/myks \
    -e COMM_KEYSTORE_PWD=password \
    -e COMM_KEY_ALIAS=tomcat \
    -e COMM_KEY_PWD=password \
    -e COMM_KEY_STORE_TYPE=JKS \
    restapi_ubuntu:7.3.0000.0590
                </code></pre>
                <pre class="fragment"><code>
curl -k https://dmadmin:password@localhost:8443/dctm-rest/repositories/REPO
                </code></pre>
            </section>
            <section>
                <section>
                    <h3>Integrating with Content Server Image</h3>
                    <p class="fragment">there are two Content Server images</p>    
                </section>
                <section>
                    <h4>Stateless Image</h4>
                    <p class="fragment">Docker Compose</p>
                    <ul>
                        <li class="fragment">postgresql in container</li>
                        <li class="fragment">REST in container</li>
                    </ul>
                    <p class="fragment">find details at <a href="https://iigwiki.corp.emc.com:8443/pages/viewpage.action?pageId=66847750">here</a></p>
                    <i class="fragment">it could take more than 30 minutes to launch</i>
                </section>
                <section>
                    <h4>All-in-one Image</h4>
                    <p class="fragment">not officially supported but quite useful</p>
                    <p class="fragment">get suite of Content Server/xPlore/REST in 10 minutes</p>
                    <a class="fragment" href="docker-rest/docker-compose.yml">docker-compose file</a><span class="fragment"> and <a href="cs-xplore-rest.sh">launching script</a></span>
                </section>
            </section>
            <section>
                <section>
                    <h2>Dockerizing REST - Scalability, LB and HA</h2>
                    <p>Two main approaches</p>
                </section>
                <section>
                    <h3 class="fragment">port traditional solutions to Docker</h3>
                    <i class="fragment">e.g., <a href="http://www.haproxy.org">HAProxy</a> and its <a href="https://iigwiki.corp.emc.com:8443/display/CMAAT/Docker+Elaboration#DockerElaboration-DockerizingHAProxySolution">Dockerized Solution</a></i>
                    <img class="fragment fade-left" src="docker-rest/haproxy.png" alt="haproxy">
                </section>
                <section>
                    <h3>pure docker solution</h3>
                    <i><a href="https://docs.docker.com/engine/swarm/">Swarm Mode</a></i>
                    <img src="docker-rest/swarm-mode.png" alt="swarm mode">
                </section>
            </section>
            <section>
                <h3>Swarm Preparation</h3>
                <ol>
                    <li class="fragment">on one Docker host</li>
                    <pre class="fragment"><code>docker swarm init</code></pre>
                    <li class="fragment">on another Docker host</li>
                    <pre class="fragment"><code>docker swarm join</code></pre>
                    <li class="fragment">if more nodes, ...</li>
                </ol>
            </section>
            <section>
                <h3>Mapping Configuration Files Cross Nodes</h3>
                <p class="fragment">network dirver or third-party solution (like <a href="https://clusterhq.com/flocker/introduction/">flocker</a>)</p>
                <b class="fragment"><i>here we will burn the configuration files in the image</i></b>
            </section>
            <section>
                <h3>Burn Configuration Files</h3>
                <pre><code>
FROM restapi_ubuntu:7.3.0000.0590
#config directory containing the necessary configuration files
COPY config/ ${CONFIG_DIR}/                    
                </code></pre>
                <pre><code>
docker build -t rest-node .                    
                </code></pre>
                <p class="fragment">push image to registry so that all swarm ndoes can get image</p>
                <pre class="fragment"><code>
docker push rest-node                    
                </code></pre>
            </section>
            <section>
                <h3>Initiate REST Services on Multiple Nodes</h3>
                <pre class="fragment"><code>
docker service create --replicas 2 --name rest-multinodes -p 8080:8080 rest-node                    
                </code></pre>
                <p class="fragment">check the service</p>
                <pre class="fragment"><code>
docker service ls                 
docker service ps rest-multinodes   
                </code></pre>
            </section>
            <section>
                <h3>Consume REST Services</h3>
                <pre class="fragment"><code>
curl http://[NODE_IP]:8080/dctm-rest/repositories/                    
                </code></pre>
            </section>
            <section data-background="#ffffff">
                <h3 style="color: black">Topology</h3>
                <img src="docker-rest/swarm-lb.png" alt="swarm load balancing">
            </section>
            <section>
                <h3>Scale REST Services</h3>
                <pre class="fragment"><code>
docker service scale rest-multinodes=3                    
                </code></pre>
                <pre class="fragment"><code>
docker service ls                   
                </code></pre>
            </section>
            <section>
                <section>
                    <h3>Upgrade REST Services Seamlessly</h3>
                    <p class="fragment">prepare a dummy new version image</p>
                    <pre class="fragment"><code>
docker tag rest-node rest-node:new
docker push rest-node:new
                    </code></pre>
                    <p class="fragment">update strategy of service</p>
                    <pre class="fragment"><code>
docker service update rest-multinodes --update-delay 20s --update-parallelism 1                    
                    </code></pre>                    
                </section>
                <section>
                    <h3>Upgrade REST Services Seamlessly (cont.)</h3>
                    <p class="fragment">kick off upgrading</p>
                    <pre class="fragment"><code>
docker service update --image rest-node:new rest-multimodes                        
                    </code></pre>
                    <p class="fragment">check the upgrading process</p>
                    <pre class="fragment"><code>
docker service ps rest-multinodes
                    </code></pre>
                </section>
            </section>
            <section>
                <h3>REST Services - HA</h3>
                <ul>
                    <li class="fragment">container is down</li>
                    <pre class="fragment"><code>
docker kill ...
                    </code></pre>
                    <li class="fragment">swarm nodes break down (docker down or server down)</li>
                    <pre class="fragment"><code>
sudo service docker stop                        
                    </code></pre>
                </ul>
            </section>
            <section>
                <h3>SAML 2.0 is new authentication schema supported in 7.3</h3>
                <p class="fragment">useful but complicated and not easy to set up</p>
                <img class="fragment" src="docker-rest/saml.png" alt="saml process">
            </section>
        </div>
    </div>
    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>
    <script>
    // More info https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // More info https://github.com/hakimel/reveal.js#dependencies
        dependencies: [{
            src: 'lib/js/classList.js',
            condition: function() {
                return !document.body.classList;
            }
        }, {
            src: 'plugin/markdown/marked.js',
            condition: function() {
                return !!document.querySelector('[data-markdown]');
            }
        }, {
            src: 'plugin/markdown/markdown.js',
            condition: function() {
                return !!document.querySelector('[data-markdown]');
            }
        }, {
            src: 'plugin/highlight/highlight.js',
            async: true,
            callback: function() {
                hljs.initHighlightingOnLoad();
            }
        }, {
            src: 'plugin/zoom-js/zoom.js',
            async: true
        }, {
            src: 'plugin/notes/notes.js',
            async: true
        }]
    });
    </script>
</body>

</html>
